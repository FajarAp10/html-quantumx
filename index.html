<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuantumX ‚Äî AI Chat</title>
<style>
/* ===========================
   GLOBAL RESET & BODY
=========================== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Inter", Arial, sans-serif;
}

html, body {
  height: 100%;
}

body {
  background: #0d0d0d;
  color: #e6e6e6;
  display: flex;
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
}

/* ===========================
   SIDEBAR
=========================== */
.sidebar {
  width: 250px;
  background: #161616;
  padding: 20px;
  border-right: 1px solid #262626;
  display: flex;
  flex-direction: column;
}

.sidebar h2 {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 18px;
}

#limitCounter {
  font-weight: 400;
  font-size: 14px;
  color: #3b82f6;
  margin-left: 6px;
}

/* ===== TOMBOL OBROLAN BARU - BEDA SEDIKIT ===== */
.new-chat {
  background: #1a1a1a;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  border: 1px solid #3b82f6;
  transition: .2s;
  font-size: 14px;
  margin-bottom: 16px;
  font-weight: 500;
  color: #fff;
  text-align: center;
}

.new-chat:hover {
  background: #252525;
  border-color: #4a8fff;
}

.chat-list {
  flex: 1;
  overflow-y: auto;
  margin-top: 5px;
}

.chat-item {
  padding: 10px;
  border-radius: 8px;
  background: #111;
  margin-bottom: 8px;
  cursor: pointer;
  border: 1px solid #262626;
  transition: .2s;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.chat-item:hover {
  background: #1a1a1a;
  border-color: #3b82f6;
}

.chat-item span {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.chat-item button {
  background: transparent;
  border: none;
  color: #ff4d4d;
  cursor: pointer;
  font-size: 15px;
  opacity: 0;
  transition: opacity 0.2s;
  padding: 4px;
}

.chat-item:hover button {
  opacity: 1;
}

.chat-item button:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* ===========================
   CHAT WRAPPER & MESSAGES
=========================== */
.chat-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
  overflow: hidden;
}

#chat {
  flex: 1 1 auto;
  padding: 22px;
  padding-bottom: 80px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  position: relative;
  min-height: 0;
  -webkit-overflow-scrolling: touch;
}

.empty-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #7a7a7a;
  font-size: 32px;
  text-align: center;
  line-height: 1.4;
  pointer-events: none;
  opacity: 0.7;
  transition: opacity .3s;
}

.msg {
  max-width: 75%;
  padding: 0;
  margin-bottom: 14px;
  display: flex;
  flex-direction: column;
  align-self: flex-start;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.3s forwards;
}

.user {
  align-self: flex-end;
}

.bot {
  align-self: flex-start;
}

.msg-content {
  padding: 14px 18px;
  line-height: 1.65;
  font-size: 15px;
  border-radius: 14px;
  border: 1px solid #262626;
  background: #111;
  white-space: pre-wrap;
  display: inline-block;
  max-width: 100%;
  overflow-x: auto;
  word-break: break-word;
}

.user .msg-content {
  background: #292929;
  border: 1px solid #333;
  border-radius: 18px 18px 4px 18px;
}

.bot .msg-content {
  background: #141414;
  border-radius: 14px 6px 6px 14px;
}

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ===========================
   INPUT AREA
=========================== */
.input-area {
  padding: 16px 20px;
  background: #0d0d0d;
  border-top: 1px solid #1a1a1a;
  display: flex;
  align-items: center;
  gap: 12px;
  position: sticky;
  bottom: 0;
  z-index: 10;
}

.input-area input {
  flex: 1;
  padding: 14px 50px 14px 20px;
  border-radius: 40px;
  border: 1px solid #333;
  background: #1a1a1a;
  color: white;
  font-size: 16px;
  outline: none;
  height: 52px;
  transition: all 0.2s ease;
}

.input-area input:focus {
  border-color: #3b82f6;
  background: #222;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

.input-area input::placeholder {
  color: #8a8a8a;
  font-weight: 400;
}

.input-area button#sendBtn {
  position: absolute;
  right: 28px;
  top: 50%;
  transform: translateY(-50%);
  width: 38px;
  height: 38px;
  border-radius: 50%;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #3b82f6;
  border: none;
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
}

.input-area button#sendBtn:hover {
  background: #4a8fff;
  transform: translateY(-50%) scale(1.05);
}

.input-area button#sendBtn:active {
  transform: translateY(-50%) scale(0.95);
}

.input-area button#uploadBtn {
  width: 42px;
  height: 42px;
  font-size: 26px;
  border-radius: 50%;
  border: none;
  background: #2a2a2a;
  color: #e6e6e6;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.input-area button#uploadBtn:hover {
  background: #3a3a3a;
  transform: scale(1.05);
}

/* ===========================
   MOBILE TOPBAR - IKON HAMBURGER BAGUS
=========================== */
.mobile-topbar {
  display: none;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: #161616;
  border-bottom: 1px solid #262626;
}

.mobile-title {
  font-size: 20px;
  font-weight: 700;
  color: #e6e6e6;
  flex: 1;
}

/* Ikon hamburger yang bagus */
.mobile-menu-btn {
  background: #2a2a2a;
  color: white;
  border: none;
  border-radius: 8px;
  width: 42px;
  height: 42px;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.mobile-menu-btn:hover {
  background: #3a3a3a;
}

.mobile-menu-btn span {
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* ===========================
   SIDEBAR OVERLAY (MOBILE)
=========================== */
.sidebar.overlay {
  display: none;
  position: fixed;
  top: 0;
  left: -300px;
  height: 100%;
  width: 280px;
  z-index: 100;
  background: #161616;
  padding: 20px;
  border-right: 1px solid #262626;
  transition: left .3s;
  box-shadow: 2px 0 10px rgba(0,0,0,0.5);
}

.sidebar.overlay.show {
  left: 0;
}

.sidebar-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 50;
}

/* ===========================
   IMAGE PREVIEW
=========================== */
#imagePreviewContainer {
  position: relative;
  display: inline-block;
  margin: 8px 16px;
  max-width: 180px;
}

#imagePreview {
  display: block;
  width: 100%;
  max-height: 120px;
  border-radius: 8px;
  border: 1px solid #262626;
  object-fit: cover;
}

#removeImageBtn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #e53935;
  color: white;
  border: none;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

#removeImageBtn:hover {
  transform: scale(1.1);
}

/* ===========================
   POPUP HAPUS
=========================== */
.popup-backdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.popup-box {
  background: #111;
  padding: 22px;
  width: 90%;
  max-width: 340px;
  border-radius: 14px;
  border: 1px solid #333;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
  text-align: center;
  animation: popupFade .25s ease;
}

.popup-box h3 {
  font-size: 18px;
  margin-bottom: 10px;
  font-weight: 700;
}

.popup-box p {
  font-size: 14px;
  margin-bottom: 18px;
  color: #ccc;
}

.popup-btns {
  display: flex;
  justify-content: space-between;
  gap: 12px;
}

.popup-btn {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 700;
  border: none;
  font-size: 14px;
}

.popup-cancel {
  background: #333;
  color: white;
}

.popup-delete {
  background: #e53935;
  color: white;
}

@keyframes popupFade {
  from { transform: scale(0.8); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

/* ===========================
   BUTTONS
=========================== */
.login-btn {
  background: transparent;
  border: none;
  padding: 0;
  font-size: 20px;
  cursor: pointer;
  color: #e6e6e6;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
  width: 40px;
  height: 40px;
  border-radius: 8px;
}

.login-btn:hover {
  background: rgba(255,255,255,0.1);
  transform: scale(1.05);
}

/* ===== CODE BLOCK ===== */
.code-block {
  background: #0f0f0f;
  border: 1px solid #333;
  padding: 14px;
  margin-top: 8px;
  border-radius: 12px;
  font-family: "Consolas", monospace;
  font-size: 14px;
  white-space: pre-wrap;
  overflow-x: auto;
  color: #1be600;
}

.msg.bot {
    background: #111;
    padding: 18px;
    border-radius: 16px;
    margin: 14px 0;
    border: 1px solid #333;
    width: fit-content;
    max-width: 90%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.msg.bot .msg-content {
  background: transparent !important;
  border: none !important;
  padding: 0 !important;
  margin: 0 !important;
  border-radius: 0 !important;
  box-shadow: none !important;
}

.loading-dots {
  display: flex;
  gap: 6px;
  align-items: center;
  height: 16px;
}

.loading-dots span {
  width: 6px;
  height: 6px;
  background: #aaa;
  border-radius: 50%;
  animation: dotPulse 1.4s infinite ease-in-out;
  opacity: 0.2;
}

.loading-dots span:nth-child(1) { animation-delay: 0s; }
.loading-dots span:nth-child(2) { animation-delay: .2s; }
.loading-dots span:nth-child(3) { animation-delay: .4s; }

@keyframes dotPulse {
  0%   { opacity: 0.2; transform: translateY(0); }
  20%  { opacity: 1;   transform: translateY(-3px); }
  40%  { opacity: 0.2; transform: translateY(0); }
  100% { opacity: 0.2; transform: translateY(0); }
}

.code-block-wrapper {
  position: relative;
}

.copy-btn {
  position: absolute;
  top: 15px;
  right: 8px;
  font-size: 12px;
  background: #222;
  border: 1px solid #444;
  color: #fff;
  padding: 3px 6px;
  border-radius: 6px;
  cursor: pointer;
  opacity: 0.6;
  transition: 0.2s;
}

.copy-btn:hover {
  opacity: 1;
}

/* ===========================
   RESPONSIVE
=========================== */
@media(max-width:700px){
  body {
    flex-direction: column;
    height: 100%;
  }

  #imagePreviewContainer {
    max-width: 150px;
  }

  .sidebar {
    display: none;
  }

  .sidebar.overlay {
    display: block;
  }

  .mobile-topbar {
    display: flex;
  }

  .chat-wrapper { min-height: 0; }
  #chat { min-height: 0; }

  #imagePreviewContainer img {
    max-width: 100%;
    max-height: 100px;
  }

  .msg { max-width: 95% !important; }
  
  .input-area {
    padding: 12px 16px;
  }
  
  .input-area input {
    padding: 12px 45px 12px 16px;
    height: 48px;
    font-size: 15px;
  }
  
  .input-area button#sendBtn {
    right: 22px;
    width: 34px;
    height: 34px;
  }
  
  .input-area button#uploadBtn {
    width: 38px;
    height: 38px;
    font-size: 24px;
  }

  .mobile-menu-btn {
    width: 40px;
    height: 40px;
    font-size: 22px;
  }
}
</style>
</head>
<body>
<!-- Sidebar Desktop -->
<div class="sidebar">
  <h2 style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <span style="font-weight:700;">QuantumX <span id="limitCounter">(5)</span></span>
    <button id="loginBtnDesktop" class="login-btn">‚öô</button>
  </h2>

  <!-- USERNAME DESKTOP -->
  <div id="userNameDisplayDesktop" style="font-size:14px; color:#ccc; margin-bottom:12px; pointer-events:none;">
    User-XXXX
  </div>
  <div class="new-chat">+ Obrolan Baru</div>
  <div class="chat-list"></div>
</div>

<!-- Chat Wrapper -->
<div class="chat-wrapper">
  <div class="mobile-topbar">
    <button id="mobileMenuBtn" class="mobile-menu-btn">
      <span>‚ò∞</span>
    </button>
    <span class="mobile-title">QuantumX</span>
    <div style="display:flex; align-items:center; gap:6px;">
      <button id="loginBtnMobile" class="login-btn">‚öô</button>
    </div>
  </div>

  <div id="chat">
    <div class="empty-text">QuantumX di sini, ada yang bisa dibantu?</div>
  </div>

  <!-- IMAGE PREVIEW -->
  <div id="imagePreviewContainer" style="display:none;">
    <img id="imagePreview" src="" alt="Preview">
    <button id="removeImageBtn">‚úï</button>
  </div>

  <!-- INPUT AREA -->
  <div class="input-area">
    <button id="uploadBtn">+</button>
    <input id="msg" placeholder="Ketik pesan..." />
    <button id="sendBtn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 19V5M5 12l7-7 7 7"/>
      </svg>
    </button>
  </div>
</div>

<!-- Sidebar Overlay (Mobile) -->
<div class="sidebar overlay">
  <h2 style="display:flex; align-items:center; justify-content:space-between;">
    QuantumX <span id="limitCounterOverlay">(5)</span>
  </h2>

  <!-- USERNAME MOBILE -->
  <div id="userNameDisplayMobileOverlay" style="font-size:14px; color:#ccc; margin-bottom:12px; pointer-events:none;">
    User-XXXX
  </div>

  <div class="new-chat">+ Obrolan Baru</div>
  <div class="chat-list"></div>
</div>
<div class="sidebar-backdrop"></div>

<!-- Popup Hapus -->
<div id="deletePopup" class="popup-backdrop">
  <div class="popup-box">
    <h3>Hapus Obrolan?</h3>
    <p>Obrolan ini akan hilang.</p>
    <div class="popup-btns">
      <button class="popup-btn popup-cancel" onclick="closePopup()">Batal</button>
      <button class="popup-btn popup-delete" id="confirmDeleteBtn">Hapus</button>
    </div>
  </div>
</div>

<script>
const backendUrl = "https://quantumx.zeabur.app";
const chatBox = document.getElementById("chat");
const input = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const chatLists = document.querySelectorAll(".chat-list");
const limitCounter = document.getElementById("limitCounter");
const limitCounterOverlay = document.getElementById("limitCounterOverlay");

// ===== STORAGE =====
let chatMemory = JSON.parse(localStorage.getItem("chatMemory")||"{}");
let chatNames = JSON.parse(localStorage.getItem("chatNames")||"{}");

let senderId = localStorage.getItem("senderId");

if (!senderId) {
  const randomNum = Math.floor(100 + Math.random() * 900);
  senderId = "User-" + randomNum;
  localStorage.setItem("senderId", senderId);
}

document.getElementById("userNameDisplayDesktop").textContent = senderId;
document.getElementById("userNameDisplayMobileOverlay").textContent = senderId;

let currentChatId = null;

// ===== FUNGSI UNTUK TUTUP SIDEBAR MOBILE =====
function closeMobileSidebar() {
  const overlaySidebar = document.querySelector(".sidebar.overlay");
  const backdrop = document.querySelector(".sidebar-backdrop");
  overlaySidebar.classList.remove("show");
  backdrop.style.display = "none";
}

// ===== INIT =====
function initChatMemory(chatId){
  if(!chatMemory[chatId]) chatMemory[chatId]=[];
  if(!chatNames[chatId]) chatNames[chatId]="Obrolan Baru";
}

function updateLimitUI(limit){
  if(limitCounter) limitCounter.textContent=`(${limit})`;
  if(limitCounterOverlay) limitCounterOverlay.textContent=`(${limit})`;
}

async function addMessage(type, text) {
    const empty = chatBox.querySelector(".empty-text");
    if (empty) empty.remove();

    const msg = document.createElement("div");
    msg.classList.add("msg", type);

    const parts = text.split(/```/);

    for (let i = 0; i < parts.length; i++) {
        const chunk = parts[i].trim();

        if (i % 2 === 0) {
            if (chunk !== "") {
                const div = document.createElement("div");
                div.classList.add("msg-content");
                msg.appendChild(div);
                await typeMessage(div, chunk);
            }
        } else {
            const wrapper = document.createElement("div");
            wrapper.classList.add("code-block-wrapper");

            const copyBtn = document.createElement("button");
            copyBtn.classList.add("copy-btn");
            copyBtn.textContent = "Salin";

            const codeDiv = document.createElement("div");
            codeDiv.classList.add("code-block");
            codeDiv.textContent = chunk;

            copyBtn.addEventListener("click", () => {
                navigator.clipboard.writeText(chunk);
                copyBtn.textContent = "Tersalin!";
                setTimeout(() => copyBtn.textContent = "Salin", 1200);
            });

            wrapper.appendChild(copyBtn);
            wrapper.appendChild(codeDiv);
            msg.appendChild(wrapper);
        }
    }

    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function renderHistoryMessage(role, content, image = null) {
    const msg = document.createElement("div");
    msg.classList.add("msg", role);

    if (image) {
        const contentDiv = document.createElement("div");
        contentDiv.classList.add("msg-content");

        const img = document.createElement("img");
        img.src = image;
        img.style.maxWidth = "80%";
        img.style.borderRadius = "12px";
        img.style.border = "1px solid #262626";

        contentDiv.appendChild(img);
        msg.appendChild(contentDiv);
    } else {
        const parts = content.split(/```/);

        for (let i = 0; i < parts.length; i++) {
            const chunk = parts[i].trim();

            if (i % 2 === 0) {
                if (chunk !== "") {
                    const div = document.createElement("div");
                    div.classList.add("msg-content");

                    if (chunk.startsWith("<div")) {
                        div.innerHTML = chunk;
                    } else {
                        div.textContent = chunk;
                    }

                    msg.appendChild(div);
                }
            } else {
                const wrapper = document.createElement("div");
                wrapper.classList.add("code-block-wrapper");

                const copyBtn = document.createElement("button");
                copyBtn.classList.add("copy-btn");
                copyBtn.textContent = "Salin";

                const codeDiv = document.createElement("div");
                codeDiv.classList.add("code-block");
                codeDiv.textContent = chunk;

                copyBtn.addEventListener("click", () => {
                    navigator.clipboard.writeText(chunk);
                    copyBtn.textContent = "Tersalin!";
                    setTimeout(() => copyBtn.textContent = "Salin", 1200);
                });

                wrapper.appendChild(copyBtn);
                wrapper.appendChild(codeDiv);
                msg.appendChild(wrapper);
            }
        }
    }

    chatBox.appendChild(msg);
}

async function typeMessage(msgContent, text) {
  const THRESHOLD = 40;
  msgContent.textContent = "";
  const animLength = Math.min(text.length, THRESHOLD);
  for (let i = 0; i < animLength; i++) {
    msgContent.textContent += text[i];
    chatBox.scrollTop = chatBox.scrollHeight;
    await new Promise(r => setTimeout(r, 10 + Math.random() * 2));
  }
  if (text.length > THRESHOLD) {
    msgContent.textContent += text.slice(THRESHOLD);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
}

// ===== IMAGE UPLOAD =====
const uploadBtn = document.getElementById("uploadBtn");
const imagePreviewContainer = document.getElementById("imagePreviewContainer");
const imagePreview = document.getElementById("imagePreview");
const removeImageBtn = document.getElementById("removeImageBtn");

let selectedImage = null;

uploadBtn.addEventListener("click", () => {
    const inputFile = document.createElement("input");
    inputFile.type = "file";
    inputFile.accept = "image/*";
    inputFile.click();

    inputFile.onchange = () => {
        const file = inputFile.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
            selectedImage = reader.result;
            imagePreview.src = selectedImage;
            imagePreviewContainer.style.display = "inline-block";
        };
        reader.readAsDataURL(file);
    };
});

removeImageBtn.addEventListener("click", () => {
    selectedImage = null;
    imagePreviewContainer.style.display = "none";
    imagePreview.src = "";
});

function appendUserImage(imageBase64) {
    const msg = document.createElement("div");
    msg.classList.add("msg", "user");

    const content = document.createElement("div");
    content.classList.add("msg-content");

    const img = document.createElement("img");
    img.src = imageBase64;
    img.style.maxWidth = "80%";
    img.style.borderRadius = "12px";
    img.style.border = "1px solid #262626";

    content.appendChild(img);
    msg.appendChild(content);
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function renderBotMessageWithCode(msg, text) {
    const parts = text.split(/```/);

    for (let i = 0; i < parts.length; i++) {
        const chunk = parts[i].trim();
        if (!chunk) continue;

        if (i % 2 === 0) {
            const div = document.createElement("div");
            div.classList.add("msg-content");
            msg.appendChild(div);
            await typeMessage(div, chunk);
        } else {
            const wrapper = document.createElement("div");
            wrapper.classList.add("code-block-wrapper");

            const copyBtn = document.createElement("button");
            copyBtn.classList.add("copy-btn");
            copyBtn.textContent = "Salin";

            const codeDiv = document.createElement("div");
            codeDiv.classList.add("code-block");
            codeDiv.textContent = chunk;

            copyBtn.onclick = () => {
                navigator.clipboard.writeText(chunk);
                copyBtn.textContent = "Tersalin!";
                setTimeout(() => copyBtn.textContent = "Salin", 1200);
            };

            wrapper.appendChild(copyBtn);
            wrapper.appendChild(codeDiv);
            msg.appendChild(wrapper);
        }
    }
}

function hideEmptyText() {
    const empty = document.querySelector(".empty-text");
    if (empty) empty.remove();
}

async function sendMsg() {
    hideEmptyText();

    const text = input.value.trim();
    if (!text && !selectedImage) return;

    sendBtn.disabled = true;

    const imageToSend = selectedImage;
    input.value = "";

    let isNewChat = false;
    if (!currentChatId) {
        const newId = "chat-" + Date.now();
        currentChatId = newId;
        initChatMemory(currentChatId);
        localStorage.setItem("activeChatId", currentChatId);
        isNewChat = true;
    } else {
        initChatMemory(currentChatId);
    }

    if (imageToSend) {
        appendUserImage(imageToSend);
        chatMemory[currentChatId].push({
            role: "user",
            content: "[image]",
            image: imageToSend
        });

        selectedImage = null;
        imagePreviewContainer.style.display = "none";
        imagePreview.src = "";
    }

    if (text) {
        await addMessage("user", text);
        chatMemory[currentChatId].push({ role: "user", content: text });
    }

    if (isNewChat && (text || imageToSend)) {
        const topic = text || "Gambar";
        const title = await generateTitle(topic);
        chatNames[currentChatId] = title;
        renderChatList();
    }

    saveMemory();

    const botMsg = document.createElement("div");
    botMsg.classList.add("msg", "bot");

    const botContent = document.createElement("div");
    botContent.classList.add("msg-content");
    botContent.innerHTML = `
        <div class="loading-dots">
            <span></span><span></span><span></span>
        </div>
    `;

    botMsg.appendChild(botContent);
    chatBox.appendChild(botMsg);
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
        let payload = { sender: senderId, message: text };
        let apiEndpoint = `${backendUrl}/api/ai`;

        if (imageToSend) {
            payload.image = imageToSend;
            apiEndpoint = `${backendUrl}/api/ai-image`;
        }

        const res = await fetch(apiEndpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("HTTP error");

        const data = await res.json();

        if (Array.isArray(data.replies)) {
            botMsg.remove();

            for (const r of data.replies) {
                if (!r.content || !r.content.trim()) continue;

                const msg = document.createElement("div");
                msg.classList.add("msg", "bot");

                const content = document.createElement("div");
                content.classList.add("msg-content");
                msg.appendChild(content);
                chatBox.appendChild(msg);

                if (r.type === "buttons") {
                    content.innerHTML = r.content;
                } else {
                    await typeMessage(content, r.content);
                }

                chatBox.scrollTop = chatBox.scrollHeight;
                chatMemory[currentChatId].push({ role: "bot", content: r.content });
            }

            saveMemory();
            if (data.remaining !== undefined) updateLimitUI(data.remaining);
            return;
        }

        const reply = data.reply || "";

        if (!reply.trim()) {
            botMsg.remove();
            return;
        }

        botContent.innerHTML = "";

        if (reply.trim().startsWith("<")) {
            botContent.innerHTML = reply;
        } else if (reply.includes("```")) {
            await renderBotMessageWithCode(botContent, reply);
        } else {
            await typeMessage(botContent, reply);
        }

        chatMemory[currentChatId].push({ role: "bot", content: reply });
        saveMemory();
        if (data.remaining !== undefined) updateLimitUI(data.remaining);

    } catch (e) {
        console.error(e);
        botMsg.remove();
        await addMessage("bot", "‚ùå Gagal terhubung ke server.");
    } finally {
        sendBtn.disabled = false;
    }
}

function loadChat(chatId) {
    currentChatId = chatId;
    localStorage.setItem("activeChatId", chatId);

    chatBox.innerHTML = "";
    initChatMemory(chatId);

    if (chatMemory[chatId].length) {
        chatMemory[chatId].forEach(m => {
            if (m.image) {
                renderHistoryMessage("user", "", m.image);
            } else {
                renderHistoryMessage(
                    m.role === "user" ? "user" : "bot",
                    m.content
                );
            }
        });
    } else {
        chatBox.innerHTML = `<div class="empty-text">QuantumX di sini, ada yang bisa dibantu?</div>`;
    }

    chatBox.scrollTop = chatBox.scrollHeight;
    fetchLimit();
    
    // Tutup sidebar mobile setelah memilih obrolan
    closeMobileSidebar();
}

function renderChatList() {
  chatLists.forEach(list => {
    list.innerHTML = "";

    const ids = Object.keys(chatMemory).reverse();

    if (ids.length === 0) {
      list.innerHTML = `<div class="empty-chat">Belum ada obrolan</div>`;
      return;
    }

    ids.forEach(chatId => {
      const item = document.createElement("div");
      item.classList.add("chat-item");

      const nameSpan = document.createElement("span");
      nameSpan.textContent = chatNames[chatId] || "Obrolan Baru";

      const delBtn = document.createElement("button");
      delBtn.innerHTML = "üóë";

      nameSpan.addEventListener("click", () => loadChat(chatId));
      delBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        showPopup(chatId);
      });

      item.appendChild(nameSpan);
      item.appendChild(delBtn);
      list.appendChild(item);
    });
  });
}

let deleteTargetChat = null;

function showPopup(chatId) {
  deleteTargetChat = chatId;
  document.getElementById("deletePopup").style.display = "flex";
}

function closePopup() {
  deleteTargetChat = null;
  document.getElementById("deletePopup").style.display = "none";
}

document.getElementById("confirmDeleteBtn").onclick = () => {
  if (!deleteTargetChat) return;

  delete chatMemory[deleteTargetChat];
  delete chatNames[deleteTargetChat];

  if (currentChatId === deleteTargetChat) {
    currentChatId = null;
    localStorage.removeItem("activeChatId");
  }

  saveMemory();
  renderChatList();
  chatBox.innerHTML = `<div class="empty-text">QuantumX di sini, ada yang bisa dibantu?</div>`;
  closePopup();
};

// ===== MOBILE SIDEBAR =====
const mobileMenuBtn = document.getElementById("mobileMenuBtn");
const overlaySidebar = document.querySelector(".sidebar.overlay");
const backdrop = document.querySelector(".sidebar-backdrop");

mobileMenuBtn.addEventListener("click", () => {
  overlaySidebar.classList.add("show");
  backdrop.style.display = "block";
});

backdrop.addEventListener("click", () => {
  closeMobileSidebar();
});

// ===== GENERATE TITLE =====
async function generateTitle(topic) {
    try {
        const res = await fetch(`${backendUrl}/api/generate-title`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: topic })
        });

        const data = await res.json();
        return data.title || "Obrolan Baru";
    } catch (e) {
        console.error("‚ùå Gagal generate title:", e);
        return "Obrolan Baru";
    }
}

document.querySelectorAll(".new-chat").forEach(btn => {
  btn.addEventListener("click", async () => {
    try {
      await fetch(`${backendUrl}/api/ai`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sender: senderId,
          message: "",
          reset: true,
          mode: localStorage.getItem("aiMode") || "normal"
        })
      });
    } catch {}

    currentChatId = null;
    localStorage.removeItem("activeChatId");
    chatBox.innerHTML = `<div class="empty-text">QuantumX di sini, ada yang bisa dibantu?</div>`;
    
    // Tutup sidebar mobile
    closeMobileSidebar();
  });
});

document.getElementById("loginBtnDesktop").onclick = () => {
  window.location.href = "settings.html";
};

document.getElementById("loginBtnMobile").onclick = () => {
  window.location.href = "settings.html";
};

async function fetchLimit() {
  try {
    const res = await fetch(`${backendUrl}/api/ai`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sender: senderId, message: "" })
    });

    const data = await res.json();
    if (data.remaining !== undefined) updateLimitUI(data.remaining);
  } catch (e) {
    console.log("‚ùå Gagal fetch limit:", e);
  }
}

function saveMemory() {
  localStorage.setItem("chatMemory", JSON.stringify(chatMemory));
  localStorage.setItem("chatNames", JSON.stringify(chatNames));
  localStorage.setItem("senderId", senderId);
}

// ===== INIT =====
renderChatList();

const activeChatId = localStorage.getItem("activeChatId");

if (activeChatId && chatMemory[activeChatId]) {
    loadChat(activeChatId);
} else if (Object.keys(chatMemory).length > 0) {
    const lastChat = Object.keys(chatMemory).slice(-1)[0];
    loadChat(lastChat);
} else {
    currentChatId = null;
    chatBox.innerHTML = `<div class="empty-text">QuantumX di sini, ada yang bisa dibantu?</div>`;
}

sendBtn.addEventListener("click", sendMsg);
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMsg();
  }
});

fetchLimit();

async function checkModeReset() {
    const shouldReset = localStorage.getItem("aiShouldReset");
    if (shouldReset === "yes") {
        try {
            await fetch(`${backendUrl}/api/ai`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    sender: senderId,
                    message: "",
                    reset: true,
                    mode: localStorage.getItem("aiMode") || "normal"
                })
            });
        } catch (e) {
            console.log("‚ùå Gagal reset AI mode:", e);
        }

        currentChatId = null;
        localStorage.removeItem("activeChatId");
        chatBox.innerHTML = `<div class="empty-text">QuantumX di sini, ada yang bisa dibantu?</div>`;
        renderChatList();
        localStorage.removeItem("aiShouldReset");
    }
}

window.addEventListener("DOMContentLoaded", checkModeReset);
window.addEventListener("focus", checkModeReset);
</script>
</body>
</html>